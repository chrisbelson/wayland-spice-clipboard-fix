#!/bin/bash

export XDG_RUNTIME_DIR="/run/user/$(id -u)"
export WAYLAND_DISPLAY="wayland-0"

# Detect X11 Display where spice-vdagent is connected to
if [ -n "$DISPLAY" ]; then
    X11_DISPLAY="$DISPLAY"
else
    # Find which display has an active X11 session
    for display in :0 :1 :2 :10; do
        if xset -display $display q >/dev/null 2>&1; then
            X11_DISPLAY="$display"
            break
        fi
    done
    
    # Fallback to socket detection if xset failed
    if [ -z "$X11_DISPLAY" ]; then
        if [ -S "/tmp/.X11-unix/X1" ]; then
            X11_DISPLAY=":1"
        elif [ -S "/tmp/.X11-unix/X0" ]; then
            X11_DISPLAY=":0"
        else
            X11_DISPLAY=":0"
        fi
    fi
fi

export DISPLAY="$X11_DISPLAY"

echo "Starting clipboard bridge"
echo "Using display: $DISPLAY"

# Verify that we can connect and clipboard works
if ! xclip -version >/dev/null 2>&1; then
    echo "Warning: Cannot connect to X11 display $DISPLAY"
    # Try to find a working display
    for test_display in :0 :1 :2 :10; do
        if DISPLAY=$test_display xclip -version >/dev/null 2>&1; then
            export DISPLAY="$test_display"
            echo "Switched to display: $DISPLAY"
            break
        fi
    done
fi

last_clipboard=""

while true; do
    current_clipboard=$(wl-paste --no-newline 2>/dev/null || true)
    
    if [ "$current_clipboard" != "$last_clipboard" ] && [ -n "$current_clipboard" ]; then
        echo -n "$current_clipboard" | xclip -selection clipboard -i 2>/dev/null
        echo "Synced: $(echo -n "$current_clipboard" | wc -c) chars"
        last_clipboard="$current_clipboard"
    fi
    
    sleep 1
done
